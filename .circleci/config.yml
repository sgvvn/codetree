# JavaScript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    docker:
      # the Docker image with Cypress dependencies
      - image: cypress/base:10
        environment:
          ## this enables colors in the output
          TERM: xterm
    working_directory: ~/app
    parallelism: 1
    steps:
      - checkout
      - restore_cache:
          keys:
            - v2-deps-{{ arch }}-{{ checksum "package-lock.json" }}
      - run: npm ci
      - save_cache:
          key: v2-deps-{{ arch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - ~/.cache
      - run:
          name: wait_on_staging_server
          command: URL=https://staging.codetree.com/pricing; RESPONSE=1; while [ $RESPONSE -ne 200 ]; do echo "waiting on $URL"; sleep 15; RESPONSE=$(curl --write-out "%{http_code}\n" --silent --output /dev/null  "$URL"); done;
      - run:
          name: e2e_regression_testing
          command: npm run cy:run